@page "/assign-grades"
@using SmartTales.Model
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IUserRepository UserRepository

<SmartTales.Components.Shared.Header Title="" />
<div class="assign-grades-container">
    <div class="header">
        <h1>Assign Grades</h1>
        <div class="search-box">
            <i class="bi bi-search"></i>
            <input type="text" placeholder="Search students..." @bind="searchQuery" @bind:event="oninput" />
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading students...</p>
        </div>
    }
    else if (students.Count == 0)
    {
        <div class="no-students">
            <i class="bi bi-people"></i>
            <h3>No Students Found</h3>
            <p>There are no registered students in the system.</p>
        </div>
    }
    else
    {
        <div class="students-grid">
            @foreach (var student in FilteredStudents)
            {
                <div class="student-card">
                    <div class="student-info">
                        <div class="student-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div class="student-details">
                            <h3>@student.FirstName @student.LastName</h3>
                            <p>ID: @student.Id</p>
                            <p>Grade: @student.GradeLevel</p>
                        </div>
                    </div>
                    <button class="btn-assign" @onclick="() => OpenGradeModal(student)">
                        <i class="bi bi-pencil-square"></i>
                        Assign Grade
                    </button>
                </div>
            }
        </div>
    }
</div>

@if (showGradeModal)
{
    <div class="modal-overlay" @onclick="CloseGradeModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2>Assign Grade - @(selectedStudent != null ? $"{selectedStudent.FirstName} {selectedStudent.LastName}" : "")</h2>
                <button class="btn-close" @onclick="CloseGradeModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Assignment</label>
                    <select class="form-control" @bind="selectedAssignment">
                        @for (int i = 1; i <= 10; i++)
                        {
                            <option value="@i">Assignment @i</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Marks</label>
                    <input type="number" class="form-control" @bind="marks" min="0" max="100" />
                </div>
                <div class="form-group">
                    <label>Remarks</label>
                    <textarea class="form-control" @bind="remarks" rows="3" placeholder="Enter feedback..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" @onclick="CloseGradeModal">Cancel</button>
                <button class="btn-save" @onclick="SaveGrade">Save Grade</button>
            </div>
        </div>
    </div>
}

@code {
    private string searchQuery = "";
    private bool showGradeModal = false;
    private User? selectedStudent;
    private int selectedAssignment = 1;
    private int marks;
    private string remarks = "";
    private bool isLoading = true;
    private List<User> students = new();

    private List<User> FilteredStudents => students
        .Where(s => string.IsNullOrEmpty(searchQuery) || 
                    s.FirstName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    s.LastName.Contains(searchQuery, StringComparison.OrdinalIgnoreCase) ||
                    s.Id.ToString().Contains(searchQuery))
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        await LoadStudents();
    }

    private async Task LoadStudents()
    {
        try
        {
            isLoading = true;
            // Get all users and filter to only kids
            var allUsers = await UserRepository.GetAllAsync();
            students = allUsers.Where(u => u.Role == "Kid").ToList();
            
            if (students.Count > 0)
            {
                Console.WriteLine($"Loaded {students.Count} students");
            }
            else
            {
                Console.WriteLine("No students found in the system");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading students: {ex.Message}");
            await JSRuntime.ToastrError("Error loading students. Please try again.");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OpenGradeModal(User student)
    {
        selectedStudent = student;
        showGradeModal = true;
        // Reset form values
        marks = 0;
        remarks = "";
        selectedAssignment = 1;
    }

    private void CloseGradeModal()
    {
        showGradeModal = false;
        selectedStudent = null;
        marks = 0;
        remarks = "";
    }

    private async Task SaveGrade()
    {
        if (selectedStudent == null) return;

        try
        {
            // Here you would save the grade to your database
            // For now, we'll just show a success message
            await JSRuntime.ToastrSuccess($"Grade assigned for {selectedStudent.FirstName} {selectedStudent.LastName}");
            CloseGradeModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving grade: {ex.Message}");
            await JSRuntime.ToastrError("Error saving grade. Please try again.");
        }
    }
} 