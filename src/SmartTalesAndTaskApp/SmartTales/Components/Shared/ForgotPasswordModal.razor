@using SmartTales.Service
@using SmartTales.Repository.IRepository
@inject PasswordResetService _passwordResetService
@inject IUserRepository _userRepository
@inject IJSRuntime _JS

@if (IsVisible)
{
    <div class="modal-overlay" @onclick="CloseModal">
        <div class="modal-content forgot-password-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>
                    <i class="fas fa-key"></i>
                    Forgot Password
                </h3>
                <button class="btn-close" @onclick="CloseModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                @if (!requestSubmitted)
                {
                    <div class="forgot-password-form">
                        <div class="info-section">
                            <div class="info-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="info-text">
                                <h4>Password Reset Process</h4>
                                <p>Enter your email address below. An administrator will reset your password and send the new password to your registered phone number within the next working hours.</p>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <div class="input-group">
                                <div class="input-icon">
                                    <i class="fas fa-envelope"></i>
                                </div>
                                <input type="email" 
                                       id="email"
                                       @bind="emailAddress" 
                                       @bind:event="oninput"
                                       class="form-control" 
                                       placeholder="Enter your registered email address"
                                       disabled="@isProcessing" />
                            </div>
                            @if (!string.IsNullOrEmpty(emailError))
                            {
                                <div class="error-message">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    @emailError
                                </div>
                            }
                        </div>

                        <div class="warning-section">
                            <div class="warning-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="warning-text">
                                <strong>Please Note:</strong> Your password will be reset by an administrator during working hours. You will receive the new password via SMS on your registered phone number.
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <div class="success-section">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="success-content">
                            <h4>Request Submitted Successfully!</h4>
                            <p>Your password reset request has been sent to the administrator.</p>
                            <div class="next-steps">
                                <h5>What happens next?</h5>
                                <ul>
                                    <li><i class="fas fa-user-shield"></i> Administrator will review your request</li>
                                    <li><i class="fas fa-key"></i> A new password will be generated</li>
                                    <li><i class="fas fa-sms"></i> You'll receive the new password via SMS</li>
                                    <li><i class="fas fa-clock"></i> This usually takes 1-4 working hours</li>
                                </ul>
                            </div>
                            <div class="contact-info">
                                <p><strong>Need immediate help?</strong></p>
                                <p>Contact support: <a href="mailto:support@smarttales.com">support@smarttales.com</a></p>
                            </div>
                        </div>
                    </div>
                }
            </div>

            <div class="modal-footer">
                @if (!requestSubmitted)
                {
                    <button class="btn btn-secondary" @onclick="CloseModal" disabled="@isProcessing">
                        Cancel
                    </button>
                    <button class="btn btn-primary" @onclick="SubmitRequest" disabled="@(isProcessing || string.IsNullOrEmpty(emailAddress))">
                        @if (isProcessing)
                        {
                            <i class="fas fa-spinner fa-spin"></i>
                            <span>Submitting...</span>
                        }
                        else
                        {
                            <i class="fas fa-paper-plane"></i>
                            <span>Submit Request</span>
                        }
                    </button>
                }
                else
                {
                    <button class="btn btn-primary" @onclick="CloseModal">
                        <i class="fas fa-check"></i>
                        Close
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private string emailAddress = "";
    private string emailError = "";
    private bool isProcessing = false;
    private bool requestSubmitted = false;

    private async Task SubmitRequest()
    {
        if (string.IsNullOrEmpty(emailAddress))
        {
            emailError = "Please enter your email address";
            return;
        }

        if (!IsValidEmail(emailAddress))
        {
            emailError = "Please enter a valid email address";
            return;
        }

        try
        {
            isProcessing = true;
            emailError = "";

            // Find user by email
            var user = await _userRepository.GetUserByEmailAsync(emailAddress);
            if (user == null)
            {
                // Don't reveal if email exists or not for security
                emailError = "If this email is registered, you will receive instructions shortly.";
                await Task.Delay(2000); // Simulate processing time
                requestSubmitted = true;
                return;
            }

            // Check if user has phone number
            if (string.IsNullOrEmpty(user.PhoneNumber))
            {
                emailError = "No phone number found for this account. Please contact support.";
                return;
            }

            // Create password reset request
            var success = await _passwordResetService.CreatePasswordResetRequestAsync(user.Id);
            if (success)
            {
                requestSubmitted = true;
                await _JS.ToastrSuccess("Password reset request submitted successfully!");
            }
            else
            {
                emailError = "Failed to submit request. Please try again later.";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error submitting password reset request: {ex.Message}");
            emailError = "An error occurred. Please try again later.";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private async Task CloseModal()
    {
        // Reset form state
        emailAddress = "";
        emailError = "";
        isProcessing = false;
        requestSubmitted = false;

        await OnClose.InvokeAsync();
    }
}
